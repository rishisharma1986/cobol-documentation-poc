IDENTIFICATION DIVISION.
PROGRAM-ID. MQCALLER.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
SOURCE-COMPUTER. IBM-390.
OBJECT-COMPUTER. IBM-390.
SPECIAL-NAMES.
    DECIMAL-POINT IS COMMA.

INPUT-OUTPUT SECTION.
FILE-CONTROL.
    SELECT PAYMENT-INSTRUCTIONS-FILE ASSIGN TO PAYMENT-INSTRUCTIONS-DS.

DATA DIVISION.
FILE SECTION.
FD PAYMENT-INSTRUCTIONS-FILE.
01 PAYMENT-INSTRUCTIONS-RECORD.
    05 CUST-CTRY PIC X(2).
    05 CUST-INSTT PIC X(5).
    05 CUST-ID PIC X(10).
    05 INSTR-REF-NUM PIC X(20).
    05 AC-CTRY PIC X(2).
    05 AC-INSTT PIC X(5).
    05 AC-NO PIC X(16).
    05 AC-PROD-TYP PIC X(5).
    05 BENE-NAM PIC X(50).
    05 BENE-ADDR1 PIC X(50).
    05 BENE-ADDR2 PIC X(50).
    05 BENE-ADDR3 PIC X(50).
    05 DEBTOR-NAME PIC X(50).
    05 DEBTOR-ADDR1 PIC X(50).
    05 DEBTOR-ADDR2 PIC X(50).
    05 DEBTOR-ADDR3 PIC X(50).
    05 INSTR-PTY PIC X(10).

WORKING-STORAGE SECTION.
01 WS-WORK-AREA.
    05 WS-CUST-CTRY PIC X(2).
    05 WS-CUST-INSTT PIC X(5).
    05 WS-CUST-ID PIC X(10).
    05 WS-INSTR-REF-NUM PIC X(20).
    05 WS-AC-CTRY PIC X(2).
    05 WS-AC-INSTT PIC X(5).
    05 WS-AC-NO PIC X(16).
    05 WS-AC-PROD-TYP PIC X(5).

01 WS-SQL-STATEMENT PIC X(255).
01 WS-SQL-RESULT PIC X(1000).

01 WS-ERROR-CODE PIC 9(4).
01 WS-ERROR-TEXT PIC X(80).

PROCEDURE DIVISION.
BEGIN.
    PERFORM GET-INPUT-DATA.
    PERFORM VALIDATE-INPUT.
    IF WS-ERROR-CODE = 0
        PERFORM FETCH-PAYMENT-INSTRUCTIONS
    ELSE
        PERFORM DISPLAY-ERROR
    END-IF.
    STOP RUN.

GET-INPUT-DATA.
    EXEC CICS GETMAIN
        SET(WS-WORK-AREA)
        LENGTH(100)
        END-EXEC.
    EXEC CICS RECEIVE
        INTO(WS-WORK-AREA)
        LENGTH(100)
        END-EXEC.

VALIDATE-INPUT.
    MOVE SPACES TO WS-ERROR-TEXT.
    IF WS-CUST-CTRY = SPACES OR WS-CUST-CTRY = LOW-VALUES
        MOVE 'Invalid Customer Country' TO WS-ERROR-TEXT
        MOVE 1 TO WS-ERROR-CODE
    END-IF.
    IF WS-CUST-INSTT = SPACES OR WS-CUST-INSTT = LOW-VALUES
        MOVE 'Invalid Customer Institution' TO WS-ERROR-TEXT
        MOVE 2 TO WS-ERROR-CODE
    END-IF.
    IF WS-CUST-ID = SPACES OR WS-CUST-ID = LOW-VALUES
        MOVE 'Invalid Customer ID' TO WS-ERROR-TEXT
        MOVE 3 TO WS-ERROR-CODE
    END-IF.
    IF WS-INSTR-REF-NUM = SPACES OR WS-INSTR-REF-NUM = LOW-VALUES
        MOVE 'Invalid Instruction Reference Number' TO WS-ERROR-TEXT
        MOVE 4 TO WS-ERROR-CODE
    END-IF.
    IF WS-AC-CTRY = SPACES OR WS-AC-CTRY = LOW-VALUES
        MOVE 'Invalid Account Country' TO WS-ERROR-TEXT
        MOVE 5 TO WS-ERROR-CODE
    END-IF.
    IF WS-AC-INSTT = SPACES OR WS-AC-INSTT = LOW-VALUES
        MOVE 'Invalid Account Institution' TO WS-ERROR-TEXT
        MOVE 6 TO WS-ERROR-CODE
    END-IF.
    IF WS-AC-NO = SPACES OR WS-AC-NO = LOW-VALUES
        MOVE 'Invalid Account Number' TO WS-ERROR-TEXT
        MOVE 7 TO WS-ERROR-CODE
    END-IF.
    IF WS-AC-PROD-TYP = SPACES OR WS-AC-PROD-TYP = LOW-VALUES
        MOVE 'Invalid Account Product Type' TO WS-ERROR-TEXT
        MOVE 8 TO WS-ERROR-CODE
    END-IF.

FETCH-PAYMENT-INSTRUCTIONS.
    MOVE 'SELECT CUST_CTRY, CUST_INSTT, CUST_ID, INSTR_REF_NUM, AC_CTRY, AC_INSTT, AC_NO, AC_PROD_TYP, BENE_NAM, BENE_ADDR1, BENE_ADDR2, BENE_ADDR3, DEBTOR_NAME, DEBTOR_ADDR1, DEBTOR_ADDR2, DEBTOR_ADDR3, INSTR_PTY FROM PAYMENTS.PAYMENT_INSTRUCTIONS WHERE CUST_CTRY = ''' TO WS-SQL-STATEMENT.
    STRING WS-CUST-CTRY DELIMITED BY SIZE
           WS-CUST-INSTT DELIMITED BY SIZE
           WS-CUST-ID DELIMITED BY SIZE
           WS-INSTR-REF-NUM DELIMITED BY SIZE
           WS-AC-CTRY DELIMITED BY SIZE
           WS-AC-INSTT DELIMITED BY SIZE
           WS-AC-NO DELIMITED BY SIZE
           WS-AC-PROD-TYP DELIMITED BY SIZE
           INTO WS-SQL-STATEMENT.
    STRING ''' AND AC_CTRY = ''' WS-AC-CTRY DELIMITED BY SIZE
           ''' AND AC_INSTT = ''' WS-AC-INSTT DELIMITED BY SIZE
           ''' AND AC_NO = ''' WS-AC-NO DELIMITED BY SIZE
           ''' AND AC_PROD_TYP = ''' WS-AC-PROD-TYP DELIMITED BY SIZE
           ''' INTO WS-SQL-STATEMENT.
    EXEC SQL
        SELECT *
        INTO :WS-SQL-RESULT
        FROM :WS-SQL-STATEMENT
        END-EXEC.

DISPLAY-ERROR.
    EXEC CICS SEND TEXT
        FROM WS-ERROR-TEXT
        LENGTH(80)
        END-EXEC.

END-PROGRAM.
